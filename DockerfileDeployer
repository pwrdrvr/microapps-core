FROM node:16 as base

WORKDIR /app

COPY ./ ./


FROM base AS build

# Add the rest of the images needed
RUN npm ci

RUN npm run build
RUN npm run lint
RUN npm run test
RUN npm run build:deployer
RUN rm distb/microapps-deployer/src/index.max.js

# Remove the Dev node modules so they are not copied into the final images
# RUN find . -name node_modules -type d -prune -exec rm -rf  {} \;

CMD ["node", "distb/microapps-deployer/src/index.js"]


FROM public.ecr.aws/lambda/nodejs:14 AS final

# Copy the prod images only
# COPY --from=prodimages /app .

# Copy the source and built source
# We want these as two layers (prodimages and built source)
# so that changes to source only push just a new code layer
# and not a new prodimages layer if that didn't change.
COPY --from=build /app/distb/microapps-deployer/* ./


CMD [ "./index.handler" ]

