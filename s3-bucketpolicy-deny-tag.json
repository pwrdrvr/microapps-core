//
// DENY non-admin and missing tag
// DENY non-admin and prefix != tag value
// 
//
// This policy works for these with `microapp-name`=`nextjs-demo`:
// - ALLOWED (correct):
//   - aws s3 cp s3://pwrdrvr-apps/nextjs-demo/0.0.1/static-pages/raQMmfxJTATU54VEE5cm6/404.html .
// - DISALLOWED (correct)
//   - aws s3 cp s3://pwrdrvr-apps/release/1.0.0/index.html .
// - ALLOWED (correct):
//   - aws s3 ls s3://pwrdrvr-apps/nextjs-demo/
// - ALLOWED (not great, but ok):
//   - aws s3 ls s3://pwrdrvr-apps/other-app/
//
{
  "Version": "2012-10-17",
  "Statement": [
      {
          "Effect": "Allow",
          "Principal": {
              "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity E1HUXB79EM4Y5R"
          },
          "Action": "s3:GetObject",
          "Resource": "arn:aws:s3:::pwrdrvr-apps/*"
      },
      {
          "Effect": "Deny",
          "NotPrincipal": {
              "AWS": [
                  "arn:aws:iam::***REMOVED***:root",
                  "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity E1HUXB79EM4Y5R",
                  "arn:aws:iam::***REMOVED***:role/AdminAccess"
              ]
          },
          "Action": "s3:*",
          "NotResource": [
              "arn:aws:s3:::pwrdrvr-apps/${aws:PrincipalTag/microapp-name}/*",
              "arn:aws:s3:::pwrdrvr-apps"
          ],
          "Condition": {
              "Null": {
                  "aws:PrincipalTag/microapp-name": "false"
              }
          }
      },
      {
          "Effect": "Deny",
          "NotPrincipal": {
              "AWS": [
                  "arn:aws:iam::***REMOVED***:root",
                  "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity E1HUXB79EM4Y5R",
                  "arn:aws:iam::***REMOVED***:role/AdminAccess"
              ]
          },
          "Action": "s3:*",
          "Resource": [
              "arn:aws:s3:::pwrdrvr-apps",
              "arn:aws:s3:::pwrdrvr-apps/*"
          ],
          "Condition": {
              "Null": {
                  "aws:PrincipalTag/microapp-name": "true"
              }
          }
      }
  ]
}